---
- import_playbook: 'pip_setup.yml'
- name: install and run heat eol tests from upstream
  hosts: undercloud

  roles:
    - testconfig

  tasks:
  - name: install git repo with tags
    git:
      repo: 'git://git.openstack.org/openstack/heat'
      dest: /home/stack/heat

  - include_tasks: 'roles/testconfig/tasks/run_requirements.yml'
  - include_tasks: 'roles/testconfig/tasks/black_list_tests.yml'
  - include_tasks: 'roles/testconfig/tasks/modify_conf_file.yml'

#  - name: install libselinux-python
#    yum:
#      name: libselinux-python
#      state: latest
#    ansible_python_interpreter: "/home/stack/ir_venv/bin/python2.7"
#    become: true

  - name: remove the testr from global
    shell: |
      sudo yum remove python-stestr
      sudo yum install libselinux-python

  - name: install by stestr pip
    pip:
      name: stestr
      virtualenv: /home/stack/ir_venv

  - include_tasks: roles/testconfig/tasks/run_requirements.yml

  - name: set group regex into stestr.conf
    ini_file:
      path: /home/stack/heat/.stestr.conf
      no_extra_spaces: yes
      section: DEFAULT
      option: group_regex
      value: heat_integrationtests\.api\.test_heat_api(?:\.|_)([^_]+)
      mode: 0642

  - name: modify conf file
    ini_file:
      path: "{{ integrationtests_path }}"
      section: heat_plugin
      option: "{{ item.option }}"
      value: "{{ item.value }}"
    with_items:
      - {option: "username", value: "demo"}
      - {option: "password", value: "secrete"}
      - {option: "auth_url", value: "{{ osp_auth.stdout }}"}
      - {option: "tenant_name", value: "demo"}
      - {option: "user_domain_name", value: "Default"}
      - {option: "project_domain_name", value: "Default"}
      - {option: "region", value: "regionOne"}
      - {option: "auth.version", value: "2"}
      - {option: "admin_username", value: "admin"}
      - {option: "admin_password", value: "{{ osp_password.stdout }}"}
      - {option: "keypair_name", value: "heat_keypair"}
      - {option: 'image_ref', value: 'heat_fedora_image'}
      - {option: 'minimal_image_ref', value: 'heat_cirros_image'}
      - {option: "instance_type", value: "m1.small"}
      - {option: "minimal_instance_type", value: "m1.tiny"}
      - {option: "image_ssh_user", value: "root"}



  - name: run tests with testr
    shell: |
      . "{{ overcloudrc }}"
      stestr init
      stestr
#      stestr --test-path=heat_integrationtests run
    args:
      chdir: /home/stack/heat



