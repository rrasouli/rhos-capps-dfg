---
- import_playbook: 'pip_setup.yml'
- name: install and run heat eol tests from upstream
  hosts: undercloud

  roles:
    - testconfig

  tasks:
    - name: install git repo with tags
      git:
        repo: 'git://git.openstack.org/openstack/heat'
        dest: /home/stack/heat
        version: tags/liberty-eol

    - include_tasks: 'roles/testconfig/tasks/run_requirements.yml'
    - include_tasks: 'roles/testconfig/tasks/black_list_tests.yml'
    - include_tasks: 'roles/testconfig/tasks/modify_conf_file.yml'

    - name: remove the testr from global
      yum:
        name: python-testrepository
        state: removed

    - name: install by testr pip
      pip:
        name: testrepository
        virtualenv: /home/stack/ir_venv
        virtualenv_site_packages: yes

    - include_tasks: roles/testconfig/tasks/run_requirements.yml

    - name: install constraints by pip
      pip:
        name: oslotest
        virtualenv: /home/stack/ir_venv
        version: 2.0.0

    - name: run tests with testr
      shell: |
        source "{{ overcloudrc }}"
        source /home/stack/ir_venv/bin/activate
        testr init
        testr run heat_integrationtests.functional
      args:
        chdir: /home/stack/heat


